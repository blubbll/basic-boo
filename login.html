<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>login or something</title>
    <meta name="description" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="robots" content="all,follow" />
    <!-- Price Slider Stylesheets -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/Primer/14.4.0/primer.min.css"
    />
    <!-- bs utilities -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-utilities@4.1.3/bootstrap-utilities.min.css"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        background: black;
      }
      body {
        overflow: hidden;
      }

      form {
        position: fixed;
        background: rgba(127, 127, 127, 0.6);
        border-radius: 0.5rem;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }
      form label {
        color: white;
        background: rgba(255, 255, 255, 0.3);
        margin-bottom: 5px;
      }
      form input {
        background: rgba(255, 255, 255, 0.1) !important;
      }
      form input::placeholder {
        color: rgba(0, 0, 0, 0.5) !important;
      }
      form[state="login"] linker {
        display: none !important;
      }
      form[state="linker"] login {
        display: none !important;
      }
    </style>
  </head>
  <body onload="$('input[name=user]').focus()">
    <canvas id="main_canvas" width="300" height="300"></canvas>

    <script>
      //selectors
      const $ = document.querySelector.bind(document),
        $$ = document.querySelectorAll.bind(document);
      const page = {
        login: _ => {
          var xhr = new XMLHttpRequest();

          xhr.onload = _ => {
            if (xhr.readyState === 4) {
              const loginOk = xhr.status === 200;
              console.log("Manual check: loggedIn?", loginOk);

              if (loginOk) {
                /*{
                  const _bak = $("form-wrapper").innerHTML;
                  $("form").remove();
                  setTimeout(() => {
                    $("form-wrapper").innerHTML = _bak;
                  }, 999);
                  }*/
                history.replaceState(null, null, location.href);
              } else {
                alert("invalid credentials!");
              }
              window.loggedIn = loginOk;
            }
          };
          xhr.open(
            "GET",
            "/login",
            true,
            $("input[name=user]").value,
            $("input[name=pass]").value
          );
          xhr.send(null);

          return false;
        },
        logout: _ => {
          window.loggedIn = false;
        }
      };
    </script>
    <form
      state="login"
      class="d-flex flex-column p-2 login"
      onsubmit="return page.login()"
      method="POST"
    >
      <login>
        <div class="d-flex flex-column text-white">
          Login with Key:
          <input name="user" class="btn-warning text-center" value="ðŸ”‘"/>
          <p>
            Account not linked yet?
          </p>
          <button
            type="button"
            onclick="page.logout()"
            class="btn btn-sm rounded-0 btn-danger m-1"
          >
          Link account now
          </button>
          
        </div>
      </login>

      <linker>
        <div class="d-flex flex-row">
          <button
            type="button"
            onclick="page.logout()"
            class="btn btn-sm rounded-0 btn-danger m-1 w-50"
          >
            LOGOUT
          </button>
          <button
            type="button"
            onclick="location.reload(true)"
            class="btn btn-sm rounded-0 btn-outline m-1 w-50"
          >
            RELOAD
          </button>
        </div>

        <label class="px-2 d-flex align-items-center"
          >user:
          <input
            required
            name="user"
            class="ml-2 form-control input-lg"
            type="text"
            autocomplete="username"
            placeholder="Username you dork"
          />
        </label>
        <label class="px-2 d-flex align-items-center"
          >pass:
          <input
            required
            name="pass"
            class="ml-2 form-control input-lg"
            type="password"
            autocomplete="current-password"
            placeholder="Password eh"
          />
        </label>
        <button type="submit" class="btn">
          SUBMIT
        </button>
      </linker>
    </form>
  </body>
  <script>
    window.loggedIn = {{status}}
    //Math things
    function randomIntInRange(a, b) {
      return ((Math.random() * (b - a + 1)) | 0) + a;
    }
    function map_line(x, x1, x2, y1, y2) {
      let m = (y2 - y1) / (x2 - x1);
      let y0 = y1 - m * x1;
      return m * x + y0;
    }

    //Objects
    function Char() {
      this.frequency = (function() {
        if (Math.random() > 0.2) {
          return 0;
        } else {
          return randomIntInRange(5, 10);
        }
      })();
      this.change = function() {
        this.value = String.fromCharCode(randomIntInRange(0x30a0, 0x30ff));
      };
      this.change();
    }
    function Column(location) {
      this.size = randomIntInRange(8, 30);
      this.position = randomIntInRange(-20, 1);
      this.location = location;
      this.speed = randomIntInRange(2, 4);
      this.chars = [];
      this.colors = [];
      for (let y = 0; y < this.size; y++) {
        this.chars[y] = new Char();

        this.colors[y] = window.loggedIn ?
          "rgba(0, 200, 70 , " + map_line(y, this.size, 0, 0, 1.1) + ")" :
        "rgba(255, 0, 70 , " + map_line(y, this.size, 0, 0, 1.1) + ")"
        ;
      }
      this.show = function(canvas) {
        canvas.fillStyle = "rgba(240, 255, 240, 1)";
        canvas.shadowColor = "rgba(255, 255, 255, 1)";
        canvas.shadowBlur = scale * 0.7;
        canvas.fillText(
          this.chars[0].value,
          this.location * scale,
          this.position * scale
        );
        for (let y = 1; y < this.size; y++) {
          canvas.fillStyle = this.colors[y];
          canvas.shadowColor = this.colors[y];
          canvas.shadowBlur = scale * 0.1;
          canvas.fillText(
            this.chars[y].value,
            this.location * scale,
            (this.position - y) * scale
          );
        }
      };
      this.run = function() {
        this.chars.unshift(new Char());
        this.chars.pop();
        this.position++;
      };
      this.change = function(frame) {
        this.chars.forEach(char => {
          if (frame % char.frequency == 0) {
            char.change();
          }
        });
      };
    }
    function Grid(fade, fontSize) {
      this.width = Math.floor(window.innerWidth / scale);
      this.height = Math.floor(window.innerHeight / scale);
      this.columns = [];
      this.fontSize = fontSize;
      this.fade = fade;
      for (let x = 0; x < this.width; x++) {
        this.columns[x] = new Column(x, this.height);
      }
      this.run = function(frame) {
        this.columns.forEach(column => {
          if (frame % column.speed == 0) {
            column.run();
          }
          column.change(frame);
        });
      };
      this.show = function(canvas) {
        draw_canvas.font = this.fontSize + "px Monospace";
        canvas.fillStyle = "rgba(0,0,0," + this.fade + ")";
        canvas.fillRect(0, 0, canvas_element.width, canvas_element.height);
        this.columns.forEach((column, index) => {
          if (column.position - column.size > this.height) {
            column.chars.forEach(char => {
              clearInterval(char.change);
            });
            this.columns[index] = new Column(index);
          } else {
            column.show(canvas);
          }
        });
      };
    }

    //Camvas
    var canvas_element = document.getElementById("main_canvas");
    canvas_element.width = window.innerWidth;
    canvas_element.height = window.innerHeight;
    var draw_canvas = canvas_element.getContext("2d");

    var scale = 20;
    draw_canvas.font = scale + "px Monospace";

    var grid = new Grid(0.5, scale);
    var grid2 = new Grid(1, scale);
    var countframes = 0;
    var draw = setInterval(function() {
      grid2.run(countframes);
      grid2.show(draw_canvas);
      grid.run(countframes);
      grid.show(draw_canvas);
      countframes++;
    }, 30);
  </script>
</html>
